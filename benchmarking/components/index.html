<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            padding: 10px;
            background: transparent;
        }

        #editor {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.8;
            outline: none;
            background: white;
        }

        #editor:focus {
            border-color: #ff4b4b;
            box-shadow: 0 0 0 2px rgba(255, 75, 75, 0.1);
        }

        .keyboard {
            margin-top: 12px;
        }

        .keyboard-section {
            margin-bottom: 8px;
        }

        .keyboard-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .keyboard-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .char-btn {
            min-width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .char-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .char-btn:active {
            background: #e0e0e0;
        }

        .marker-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #fff3cd;
            border-color: #ffc107;
        }

        .marker-btn:hover {
            background: #ffe69c;
        }

        .section-toggle {
            font-size: 12px;
            color: #666;
            cursor: pointer;
            user-select: none;
            margin-bottom: 4px;
        }

        .section-toggle:hover {
            color: #333;
        }

        .collapsible {
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .collapsed {
            max-height: 0 !important;
        }
    </style>
</head>
<body>
    <div id="editor" contenteditable="true"></div>

    <div class="keyboard">
        <!-- Uncertainty Markers -->
        <div class="keyboard-section">
            <div class="keyboard-label">Quick Markers</div>
            <div class="keyboard-row">
                <button class="char-btn marker-btn" onclick="insertText(' [unclear] ')">unclear</button>
                <button class="char-btn marker-btn" onclick="insertText(' [noise] ')">noise</button>
                <button class="char-btn marker-btn" onclick="insertText(' [overlap] ')">overlap</button>
                <button class="char-btn" onclick="insertText(' ')" title="Space">_</button>
            </div>
        </div>

        <!-- Vowels -->
        <div class="keyboard-section">
            <div class="keyboard-label">Vowels (Swar)</div>
            <div class="keyboard-row" id="vowels"></div>
        </div>

        <!-- Matras -->
        <div class="keyboard-section">
            <div class="keyboard-label">Matras</div>
            <div class="keyboard-row" id="matras"></div>
        </div>

        <!-- Consonants (collapsible) -->
        <div class="keyboard-section">
            <div class="section-toggle" onclick="toggleSection('consonants')">
                Consonants (Vyanjan) <span id="consonants-toggle">+</span>
            </div>
            <div class="collapsible collapsed" id="consonants" style="max-height: 300px;">
                <div class="keyboard-row" id="consonants-row"></div>
            </div>
        </div>

        <!-- Extras (collapsible) -->
        <div class="keyboard-section">
            <div class="section-toggle" onclick="toggleSection('extras')">
                Conjuncts & Extras <span id="extras-toggle">+</span>
            </div>
            <div class="collapsible collapsed" id="extras" style="max-height: 100px;">
                <div class="keyboard-row" id="extras-row"></div>
            </div>
        </div>

        <!-- Numbers (collapsible) -->
        <div class="keyboard-section">
            <div class="section-toggle" onclick="toggleSection('numbers')">
                Numbers <span id="numbers-toggle">+</span>
            </div>
            <div class="collapsible collapsed" id="numbers" style="max-height: 50px;">
                <div class="keyboard-row" id="numbers-row"></div>
            </div>
        </div>
    </div>

    <script>
        // Character sets
        const VOWELS = 'अ आ इ ई उ ऊ ऋ ए ऐ ओ औ अं अः'.split(' ');
        const MATRAS = 'ा ि ी ु ू ृ े ै ो ौ ं ः ँ ्'.split(' ');
        const CONSONANTS = [
            'क', 'ख', 'ग', 'घ', 'ङ',
            'च', 'छ', 'ज', 'झ', 'ञ',
            'ट', 'ठ', 'ड', 'ढ', 'ण',
            'त', 'थ', 'द', 'ध', 'न',
            'प', 'फ', 'ब', 'भ', 'म',
            'य', 'र', 'ल', 'व',
            'श', 'ष', 'स', 'ह',
            'ळ'  // Marathi-specific
        ];
        const EXTRAS = 'क्ष त्र ज्ञ श्र ़ । ॥'.split(' ');
        const NUMBERS = '० १ २ ३ ४ ५ ६ ७ ८ ९'.split(' ');

        const editor = document.getElementById('editor');

        // Build keyboard buttons
        function buildRow(chars, containerId) {
            const container = document.getElementById(containerId);
            chars.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'char-btn';
                btn.textContent = char;
                btn.onclick = () => insertText(char);
                container.appendChild(btn);
            });
        }

        buildRow(VOWELS, 'vowels');
        buildRow(MATRAS, 'matras');
        buildRow(CONSONANTS, 'consonants-row');
        buildRow(EXTRAS, 'extras-row');
        buildRow(NUMBERS, 'numbers-row');

        // Toggle collapsible sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            const toggle = document.getElementById(id + '-toggle');
            section.classList.toggle('collapsed');
            toggle.textContent = section.classList.contains('collapsed') ? '+' : '-';
        }

        // Store last known selection for when editor loses focus
        let savedSelection = null;

        // Save selection when it changes
        document.addEventListener('selectionchange', () => {
            if (document.activeElement === editor) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    savedSelection = selection.getRangeAt(0).cloneRange();
                }
            }
        });

        // Insert text at cursor position
        function insertText(text) {
            editor.focus();

            // Restore saved selection if we have one
            if (savedSelection) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedSelection);
            }

            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                // Update saved selection
                savedSelection = range.cloneRange();
            } else {
                // Fallback: append to end
                editor.textContent += text;
            }

            sendToStreamlit();
        }

        // Send content to Streamlit
        function sendToStreamlit() {
            const content = editor.innerText;
            if (window.Streamlit) {
                Streamlit.setComponentValue(content);
            }
        }

        // Streamlit component integration
        function onRender(event) {
            // Get initial value from Streamlit
            if (event.detail && event.detail.args) {
                const args = event.detail.args;
                // Only set initial value if editor is empty (first render)
                if (args.initial_value !== undefined && !editor.hasAttribute('data-initialized')) {
                    editor.textContent = args.initial_value;
                    editor.setAttribute('data-initialized', 'true');
                }
            }

            // Set frame height
            if (window.Streamlit) {
                Streamlit.setFrameHeight(document.body.scrollHeight + 20);
            }
        }

        // Handle keyboard input - also send to Streamlit
        editor.addEventListener('input', sendToStreamlit);

        // Wait for Streamlit to be available
        function initStreamlit() {
            if (window.Streamlit) {
                // Listen for render events from Streamlit
                Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, onRender);
                // Tell Streamlit we're ready
                Streamlit.setComponentReady();
                // Set initial frame height
                Streamlit.setFrameHeight(document.body.scrollHeight + 20);
            } else {
                // Retry after a short delay
                setTimeout(initStreamlit, 100);
            }
        }

        // Update height on content change
        const resizeObserver = new ResizeObserver(() => {
            if (window.Streamlit) {
                Streamlit.setFrameHeight(document.body.scrollHeight + 20);
            }
        });
        resizeObserver.observe(document.body);

        // Start initialization
        initStreamlit();
    </script>
</body>
</html>
